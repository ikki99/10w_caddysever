// app.js - Caddy Manager Frontend
let currentPath = '';
let currentEnvs = [];

// é¡µé¢åŠ è½½
window.onload = function() {
    loadSystemInfo();
};

// åŠ è½½ç³»ç»Ÿä¿¡æ¯
async function loadSystemInfo() {
    try {
        const res = await fetch('/api/system/info');
        const data = await res.json();
        
        document.getElementById('system-info').style.display = 'block';
        
        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        const grid = document.getElementById('sys-info-grid');
        grid.innerHTML = `
            <div class="info-item">
                <h4>æ“ä½œç³»ç»Ÿ</h4>
                <p>${data.os}</p>
            </div>
            <div class="info-item">
                <h4>æ¶æ„</h4>
                <p>${data.arch}</p>
            </div>
            <div class="info-item">
                <h4>CPUæ ¸å¿ƒ</h4>
                <p>${data.cpu_cores} æ ¸</p>
            </div>
        `;
        
        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        const envList = document.getElementById('env-info-list');
        currentEnvs = data.environments;
        envList.innerHTML = data.environments.map(env => `
            <div class="file-item">
                <div>
                    <strong>${env.name}</strong>
                    <span class="env-status ${env.installed ? 'env-installed' : 'env-not-installed'}">
                        ${env.installed ? 'å·²å®‰è£… ' + env.version : 'æœªå®‰è£…'}
                    </span>
                    ${env.path ? '<br><small>' + env.path + '</small>' : ''}
                </div>
            </div>
        `).join('');
        
    } catch (err) {
        console.error('åŠ è½½ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', err);
    }
}

function continueToLogin() {
    document.getElementById('system-info').style.display = 'none';
    checkFirstRun();
}

async function checkFirstRun() {
    const res = await fetch('/api/setup');
    const data = await res.json();
    if (data.firstRun) {
        document.getElementById('setup-page').style.display = 'block';
    } else {
        document.getElementById('login-page').style.display = 'block';
    }
}

// è®¾ç½®è¡¨å•
document.getElementById('setup-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('setup-username').value;
    const password = document.getElementById('setup-password').value;
    const password2 = document.getElementById('setup-password2').value;
    
    if (password !== password2) {
        alert('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´');
        return;
    }

    const res = await fetch('/api/setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    });

    if (res.ok) {
        alert('è®¾ç½®å®Œæˆï¼Œè¯·ç™»å½•');
        document.getElementById('setup-page').style.display = 'none';
        document.getElementById('login-page').style.display = 'block';
    } else {
        alert('è®¾ç½®å¤±è´¥');
    }
});

// ç™»å½•è¡¨å•
document.getElementById('login-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;

    const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    });

    if (res.ok) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadSites();
        checkCaddyStatus();
        setInterval(checkCaddyStatus, 10000);
    } else {
        alert('ç™»å½•å¤±è´¥');
    }
});

// åŠ è½½ç«™ç‚¹åˆ—è¡¨
async function loadSites() {
    const res = await fetch('/api/sites');
    const sites = await res.json();
    const list = document.getElementById('site-list');
    list.innerHTML = sites.map(site => `
        <li class="site-item">
            <div>
                <strong>${site.domain}</strong>
                <span style="color: #909399; margin-left: 10px;">
                    ${site.type === 'proxy' ? 'åå‘ä»£ç†' : (site.type === 'php' ? 'PHPç«™ç‚¹' : 'é™æ€ç«™ç‚¹')} â†’ ${site.target}
                </span>
                ${site.environment ? '<br><small>ç¯å¢ƒ: ' + site.environment + (site.php_version ? ' ' + site.php_version : '') + '</small>' : ''}
            </div>
            <div>
                <button class="btn btn-danger" onclick="deleteSite(${site.id})">åˆ é™¤</button>
            </div>
        </li>
    `).join('');
}

// æ˜¾ç¤ºæ·»åŠ ç«™ç‚¹
function showAddSite() {
    document.getElementById('add-site-modal').style.display = 'block';
}

// ç«™ç‚¹ç±»å‹æ”¹å˜
function onSiteTypeChange() {
    const type = document.getElementById('site-type').value;
    const targetLabel = document.getElementById('target-label');
    const targetInput = document.getElementById('site-target');
    const envGroup = document.getElementById('env-group');
    
    if (type === 'static') {
        targetLabel.textContent = 'ç½‘ç«™ç›®å½•';
        targetInput.placeholder = 'C:\\www\\mysite';
        envGroup.style.display = 'none';
    } else if (type === 'proxy') {
        targetLabel.textContent = 'ç›®æ ‡åœ°å€';
        targetInput.placeholder = 'http://localhost:3000';
        envGroup.style.display = 'none';
    } else if (type === 'php') {
        targetLabel.textContent = 'ç½‘ç«™ç›®å½•';
        targetInput.placeholder = 'C:\\www\\mysite';
        envGroup.style.display = 'block';
    }
}

// æäº¤æ·»åŠ ç«™ç‚¹
async function submitAddSite() {
    const domain = document.getElementById('site-domain').value;
    const type = document.getElementById('site-type').value;
    const target = document.getElementById('site-target').value;
    const phpVersion = document.getElementById('php-version').value;
    
    if (!domain || !target) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    const site = {
        domain,
        type,
        target,
        ssl_enabled: true,
        environment: type === 'php' ? 'php' : '',
        php_version: type === 'php' ? phpVersion : ''
    };
    
    const res = await fetch('/api/sites/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(site)
    });
    
    if (res.ok) {
        closeModal('add-site-modal');
        loadSites();
        alert('ç«™ç‚¹æ·»åŠ æˆåŠŸ');
    } else {
        alert('æ·»åŠ å¤±è´¥');
    }
}

// åˆ é™¤ç«™ç‚¹
function deleteSite(id) {
    if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
    fetch('/api/sites/delete?id=' + id, { method: 'POST' })
        .then(() => loadSites());
}

// åˆ‡æ¢æ ‡ç­¾
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
    
    if (tab === 'files') loadFiles('');
    if (tab === 'logs') refreshLogs();
    if (tab === 'env') loadEnvs();
    if (tab === 'settings') loadSettings();
}

// æ–‡ä»¶ç®¡ç†
async function loadFiles(path) {
    currentPath = path;
    const res = await fetch('/api/files/browse?path=' + encodeURIComponent(path));
    const data = await res.json();
    
    document.getElementById('file-breadcrumb').textContent = 'å½“å‰ç›®å½•: ' + data.current_path;
    
    const browser = document.getElementById('file-browser');
    let html = '';
    
    if (data.parent_path && data.parent_path !== data.current_path) {
        html += `<div class="file-item" onclick="loadFiles('${data.parent_path}')">
            <div><span class="file-icon">ğŸ“</span>..</div>
        </div>`;
    }
    
    html += data.files.map(f => `
        <div class="file-item">
            <div onclick="${f.is_dir ? 'loadFiles(\'' + f.path + '\')' : ''}">
                <span class="file-icon">${f.is_dir ? 'ğŸ“' : 'ğŸ“„'}</span>${f.name}
                ${!f.is_dir ? '<small> (' + formatSize(f.size) + ')</small>' : ''}
            </div>
            <div>
                ${!f.is_dir ? '<button class="btn btn-primary" onclick="downloadFile(\'' + f.path + '\', \'' + f.name + '\')">ä¸‹è½½</button>' : ''}
                <button class="btn btn-danger" onclick="deleteFile('${f.path}')">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
    
    browser.innerHTML = html;
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function uploadFileToPath() {
    const file = document.getElementById('file-upload').files[0];
    if (!file) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('path', currentPath);
    
    fetch('/api/files/upload', {
        method: 'POST',
        body: formData
    }).then(() => {
        loadFiles(currentPath);
        document.getElementById('file-upload').value = '';
    });
}

function createNewFolder() {
    const name = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:');
    if (!name) return;
    
    fetch('/api/files/create-folder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: currentPath, name })
    }).then(() => loadFiles(currentPath));
}

function deleteFile(path) {
    if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
    fetch('/api/files/delete?path=' + encodeURIComponent(path), { method: 'POST' })
        .then(() => loadFiles(currentPath));
}

function downloadFile(path, name) {
    window.open('/api/files/download?path=' + encodeURIComponent(path), '_blank');
}

// æ—¥å¿—ç®¡ç†
async function refreshLogs() {
    const res = await fetch('/api/caddy/logs');
    const data = await res.json();
    document.getElementById('log-content').textContent = data.logs || 'æš‚æ— æ—¥å¿—';
    document.getElementById('log-content').scrollTop = document.getElementById('log-content').scrollHeight;
}

// ç¯å¢ƒç®¡ç†
async function loadEnvs() {
    const list = document.getElementById('env-list');
    list.innerHTML = currentEnvs.map(env => `
        <div class="file-item">
            <div>
                <strong>${env.name}</strong>
                <span class="env-status ${env.installed ? 'env-installed' : 'env-not-installed'}">
                    ${env.installed ? 'å·²å®‰è£… ' + env.version : 'æœªå®‰è£…'}
                </span>
            </div>
            <div>
                ${!env.installed ? '<button class="btn btn-warning" onclick="showEnvGuide(\'' + env.name.toLowerCase() + '\')">å®‰è£…æŒ‡å—</button>' : ''}
            </div>
        </div>
    `).join('');
}

async function showEnvGuide(env) {
    const res = await fetch('/api/env/guide', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ env })
    });
    
    const guide = await res.json();
    document.getElementById('guide-title').textContent = guide.title;
    document.getElementById('guide-steps').textContent = guide.steps;
    document.getElementById('guide-download-btn').onclick = () => window.open(guide.download, '_blank');
    document.getElementById('env-guide-modal').style.display = 'block';
}

// è®¾ç½®ç®¡ç†
async function loadSettings() {
    const res = await fetch('/api/settings/get');
    const data = await res.json();
    document.getElementById('security-path').value = data.security_path || '';
    document.getElementById('www-root').value = data.www_root || 'C:\\www';
}

async function saveSettings() {
    const securityPath = document.getElementById('security-path').value;
    const wwwRoot = document.getElementById('www-root').value;
    
    const res = await fetch('/api/settings/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ security_path: securityPath, www_root: wwwRoot })
    });
    
    if (res.ok) {
        alert('è®¾ç½®å·²ä¿å­˜ï¼');
    } else {
        alert('ä¿å­˜å¤±è´¥');
    }
}

async function changePassword() {
    const username = document.getElementById('change-username').value;
    const oldPassword = document.getElementById('old-password').value;
    const newPassword = document.getElementById('new-password').value;
    const newPassword2 = document.getElementById('new-password2').value;
    
    if (!username || !oldPassword || !newPassword) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    if (newPassword !== newPassword2) {
        alert('ä¸¤æ¬¡æ–°å¯†ç ä¸ä¸€è‡´');
        return;
    }
    
    const res = await fetch('/api/user/password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, old_password: oldPassword, new_password: newPassword })
    });
    
    if (res.ok) {
        alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
        logout();
    } else {
        const text = await res.text();
        alert('ä¿®æ”¹å¤±è´¥: ' + text);
    }
}

// Caddy çŠ¶æ€
async function checkCaddyStatus() {
    const res = await fetch('/api/caddy/status');
    const data = await res.json();
    document.getElementById('caddy-status').textContent = data.running ? 'âœ… Caddy è¿è¡Œä¸­' : 'âŒ Caddy æœªè¿è¡Œ';
}

// é€€å‡ºç™»å½•
function logout() {
    fetch('/api/logout', { method: 'POST' })
        .then(() => location.reload());
}

// æ¨¡æ€æ¡†
function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
