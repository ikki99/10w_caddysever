# Caddy Manager 完整操作教程

## 🎯 目标
本教程将指导你完成从安装到部署项目的完整流程，确保每一步都有明确的提示和反馈。

---

## 📋 第一步：安装和启动

### 1.1 下载程序
下载 `caddy-manager.exe` 或 `caddy-manager-console.exe`

### 1.2 以管理员身份运行
**重要**: 必须以管理员身份运行才能绑定 80/443 端口

**操作步骤**:
1. 右键点击 `caddy-manager-console.exe`
2. 选择 **"以管理员身份运行"**
3. 在 UAC 对话框中点击 **"是"**

**预期结果**:
```
✓ 已以管理员权限运行
============================================================
                  Caddy 管理器 v0.1.0
============================================================

🌐 访问地址: http://localhost:8989
📋 系统托盘: 已启用 (右键查看菜单)
📊 按 Ctrl+C 停止服务
```

**如果显示警告**:
```
⚠️  警告: 未以管理员身份运行
============================================================

当前程序未以管理员权限运行，这可能导致以下问题：
  • 无法绑定 80 和 443 端口
  • 无法自动申请 SSL 证书
  • 无法配置防火墙规则

建议操作：
  1. 关闭本程序
  2. 右键程序图标 → 选择'以管理员身份运行'
```

**解决方法**: 按提示重新以管理员身份运行

---

## 📋 第二步：系统诊断

### 2.1 打开管理界面
1. 打开浏览器
2. 访问: `http://localhost:8989`
3. 首次使用需要设置管理员账号

### 2.2 运行系统诊断
1. 点击顶部 **"设置"** 标签
2. 找到 **"系统诊断"** 区域
3. 点击 **"🔍 运行诊断"** 按钮

**预期结果**:
```
诊断结果 (2025/10/8 12:00:00)

✓ 未发现问题，系统运行正常
```

**如果发现问题**:
```
诊断结果

❌ 端口 80 被占用
端口 80 被进程 httpd.exe 占用，Caddy 无法启动

解决方案:
1. 停止 httpd.exe 进程
2. 或使用其他端口（如 8080）
3. 点击'自动修复'尝试释放端口

[自动修复]
```

**操作**: 点击 **[自动修复]** 按钮

---

## 📋 第三步：创建第一个项目

### 3.1 进入项目管理
1. 点击顶部 **"项目管理"** 标签
2. 点击 **"新建项目"** 按钮

### 3.2 选择项目类型
在第 1 步中选择你的项目类型:
- **Go 项目**: 编译后的可执行文件
- **Python 项目**: Python 脚本
- **Node.js 项目**: JavaScript 应用
- **静态网站**: HTML/CSS/JS 文件

**示例**: 选择 "Node.js 项目"

点击 **"下一步"**

### 3.3 配置基本信息

**项目名称**: `我的Node应用`  
**项目根目录**: `D:\projects\my-app`  
**启动命令**: `app.js` (或 `npm start`)  
**监听端口**: `3000`  
**开机自启**: `否`

**重要提示**:
- ✅ 根目录必须存在
- ✅ 启动命令是相对于根目录的
- ✅ 端口不能与其他项目冲突

点击 **"下一步"**

### 3.4 域名配置

**绑定域名** (可选):
```
example.com
www.example.com
```

**启用 SSL**: 
- 如果有域名选 **"是"**
- 本地测试选 **"否"**

**证书邮箱** (启用SSL时):
```
admin@example.com
```

**重要**: 
- 域名必须已解析到服务器
- 80 和 443 端口必须开放
- 需要管理员权限

点击 **"下一步"**

### 3.5 高级选项

**反向代理路径**: `/` (默认)  
**额外 Header**: (可选)

点击 **"创建项目"**

### 3.6 查看创建结果

**成功示例**:
```
✓ 项目 '我的Node应用' 创建成功

⚠ SSL 配置提示:
  1. ⚠ 域名 example.com 使用 Cloudflare CDN，建议:
     1. 使用 Flexible SSL 模式
     2. 或临时关闭 Cloudflare 代理申请证书
```

**配置错误示例**:
```
❌ 项目配置验证失败

详细信息:
  1. ❌ 项目根目录不存在: D:\projects\my-app
  2. ❌ 端口号无效: 0 (应在 1-65535 之间)

请检查并修正后重试
```

**解决方法**: 按提示修正配置

---

## 📋 第四步：启动项目

### 4.1 启动项目
在项目卡片上点击 **"启动"** 按钮

**成功示例**:
```
✓ 项目 '我的Node应用' 启动成功

端口: 3000
```

**失败示例 1 - 文件不存在**:
```
❌ 启动失败: 找不到可执行文件或脚本

解决方案:
  1. 检查可执行文件路径: 
  2. 检查启动命令: app.js
  3. 确认文件存在于: D:\projects\my-app
```

**解决方法**:
1. 检查文件是否存在
2. 编辑项目修正路径
3. 重新启动

**失败示例 2 - 端口占用**:
```
❌ 启动失败: 端口 3000 已被占用

解决方案:
  1. 运行系统诊断检查端口占用
  2. 停止占用端口 3000 的程序
  3. 或修改项目使用其他端口
```

**解决方法**:
```powershell
# 在命令行中查看端口占用
netstat -ano | findstr :3000

# 停止进程 (替换 PID)
taskkill /F /PID 12345
```

**失败示例 3 - Node.js 未安装**:
```
❌ 启动失败: 未安装 Node.js

解决方案:
  1. 访问 https://nodejs.org 下载 Node.js
  2. 安装后确保添加到环境变量
  3. 运行 'node --version' 验证
```

**解决方法**:
1. 下载安装 Node.js
2. 重启命令行
3. 验证: `node --version`
4. 重新启动项目

### 4.2 查看项目日志
如果启动失败:
1. 点击 **"日志"** 按钮
2. 查看详细错误信息
3. 或查看文件: `data/logs/project_1.log`

---

## 📋 第五步：SSL 证书配置

### 5.1 检查 SSL 配置
1. 进入 **"设置"** 标签
2. 点击 **"🔒 检查 SSL 配置"**
3. 输入域名: `example.com`

**正常示例**:
```
SSL 诊断结果 - example.com

✓ SSL 配置正常
```

**Cloudflare 示例**:
```
SSL 诊断结果 - c808.333.606.f89f.top

⚠ 检测到 Cloudflare CDN
域名解析到 Cloudflare IP: 104.21.30.140
使用 Cloudflare 代理时，Let's Encrypt 无法直接验证域名

建议:
1. 推荐: 使用 Cloudflare Flexible SSL 模式（无需服务器证书）
2. 或: 临时关闭 Cloudflare 代理（DNS 记录橙云变灰云）
3. 或: 使用 Cloudflare Origin CA 证书
```

### 5.2 解决方案

#### 方案 A: Cloudflare Flexible SSL (推荐)
1. 登录 Cloudflare 控制台
2. 进入你的域名
3. **SSL/TLS** → **Overview**
4. 选择 **"Flexible"**
5. 在项目中**禁用 SSL**
6. Cloudflare 会自动处理 HTTPS

#### 方案 B: 临时关闭代理
1. Cloudflare → DNS 设置
2. 找到 A 记录
3. 点击**橙色云**图标变成**灰色**
4. 等待 5-10 分钟 DNS 生效
5. 重启 Caddy 申请证书
6. 成功后重新开启橙色云

#### 方案 C: Origin CA 证书
1. Cloudflare → **SSL/TLS** → **Origin Server**
2. **Create Certificate**
3. 下载证书和私钥
4. 手动配置到 Caddyfile

---

## 📋 第六步：访问项目

### 6.1 本地访问
如果未配置域名:
```
http://localhost:3000
```

### 6.2 通过 Caddy 访问
如果配置了域名:
```
http://example.com       (HTTP)
https://example.com      (HTTPS, 如果配置了 SSL)
```

### 6.3 验证反向代理
访问域名应该能看到你的应用

**如果出现 502 错误**:
```
❌ 502 Bad Gateway
```

**原因**: 后端项目没有运行

**解决方法**:
1. 检查项目是否启动
2. 查看项目状态
3. 查看项目日志

---

## 📋 常见问题诊断

### 问题 1: Caddy 无法启动

**症状**: 点击重启 Caddy 没反应

**诊断步骤**:
1. 运行系统诊断
2. 查看 Caddy 日志: `data/caddy/caddy.log`
3. 检查 Caddyfile: `data/caddy/Caddyfile`

**常见原因**:
- 端口 80/443 被占用
- Caddyfile 格式错误
- 权限不足

### 问题 2: SSL 证书申请失败

**症状**: HTTPS 无法访问

**诊断步骤**:
1. 检查管理员权限
2. 检查域名解析
3. 检查 80/443 端口
4. 查看 Caddy 日志

**常见原因**:
- 未以管理员运行
- 域名未解析
- 使用 Cloudflare CDN
- 端口被防火墙阻止

### 问题 3: 项目启动失败

**症状**: 点击启动后状态仍为"已停止"

**诊断步骤**:
1. 查看启动错误提示
2. 查看项目日志
3. 手动测试启动命令

**常见原因**:
- 文件路径错误
- 启动命令错误
- 运行时未安装
- 端口被占用

---

## 📋 诊断脚本使用

### 快速诊断
```powershell
# 在项目目录运行
powershell -ExecutionPolicy Bypass -File diagnose.ps1
```

### SSL 问题诊断
```powershell
# 在项目目录运行
powershell -ExecutionPolicy Bypass -File fix-ssl.ps1
```

按照脚本提示操作

---

## 📝 检查清单

### 启动前检查
- [ ] 以管理员身份运行
- [ ] 运行系统诊断无错误
- [ ] Caddy 正常运行

### 创建项目检查
- [ ] 项目根目录存在
- [ ] 启动命令正确
- [ ] 端口未被占用
- [ ] 运行时已安装

### SSL 配置检查
- [ ] 域名已解析
- [ ] 80 和 443 端口开放
- [ ] 管理员权限
- [ ] Cloudflare 配置正确

---

## 🆘 获取帮助

### 查看日志
```
Caddy 日志: data/caddy/caddy.log
项目日志: data/logs/project_<id>.log
```

### 运行诊断
```
Web 界面 → 设置 → 系统诊断 → 运行诊断
```

### 查看文档
```
DIAGNOSTICS_GUIDE.md    - 诊断功能
SSL_TROUBLESHOOTING.md  - SSL 故障排查
FILE_UPLOAD_GUIDE.md    - 文件上传
```

---

**版本**: v0.1.0  
**最后更新**: 2025年

这才是一个完整的、用户友好的操作教程！每一步都有明确的提示和错误处理。
