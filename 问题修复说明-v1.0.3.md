# é—®é¢˜ä¿®å¤è¯´æ˜

## æ›´æ–°æ—¥æœŸï¼š2025-01-09
## ç‰ˆæœ¬ï¼šv1.0.3

---

## ğŸ› ä¿®å¤çš„é—®é¢˜

### é—®é¢˜ 1ï¼šæ–°å»ºæ–‡ä»¶å¤¹ä½ç½®é”™è¯¯ âœ…

**é—®é¢˜æè¿°ï¼š**
- åœ¨æ–‡ä»¶ç®¡ç†å™¨ä¸­ç‚¹å‡»"æ–°å»ºæ–‡ä»¶å¤¹"
- æ–‡ä»¶å¤¹è¢«åˆ›å»ºåœ¨ç¨‹åºè¿è¡Œç›®å½•ï¼Œè€Œä¸æ˜¯å½“å‰æµè§ˆçš„ç›®å½•

**é—®é¢˜æ ¹æºï¼š**
```javascript
let currentPath = '';  // åˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸²
```

å½“ç”¨æˆ·æœªè¿›å…¥æ–‡ä»¶ç®¡ç†æ ‡ç­¾å°±ç‚¹å‡»æ–°å»ºæ–‡ä»¶å¤¹æ—¶ï¼Œ`currentPath` ä¸ºç©ºï¼Œå¯¼è‡´åœ¨ç¨‹åºè¿è¡Œç›®å½•åˆ›å»ºã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ·»åŠ åˆå§‹åŒ–å‡½æ•°**
```javascript
async function initializeFilePath() {
    try {
        const res = await fetch('/api/settings/get');
        const data = await res.json();
        currentPath = data.www_root || 'E:\\www';
    } catch (err) {
        currentPath = 'E:\\www'; // é»˜è®¤è·¯å¾„
    }
}
```

2. **åœ¨ç™»å½•æˆåŠŸåç«‹å³åˆå§‹åŒ–**
```javascript
if (res.ok) {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    
    initializeFilePath(); // åˆå§‹åŒ–æ–‡ä»¶è·¯å¾„
    
    loadSystemInfo();
    // ...
}
```

**ä¿®å¤æ•ˆæœï¼š**
- âœ… ç™»å½•åç«‹å³è·å–é»˜è®¤ www æ ¹ç›®å½•
- âœ… currentPath å§‹ç»ˆæœ‰æœ‰æ•ˆå€¼
- âœ… æ–°å»ºæ–‡ä»¶å¤¹åœ¨æ­£ç¡®çš„ä½ç½®åˆ›å»º

**æµ‹è¯•æ­¥éª¤ï¼š**
1. ç™»å½•ç³»ç»Ÿ
2. ä¸è¿›å…¥æ–‡ä»¶ç®¡ç†æ ‡ç­¾
3. è¿›å…¥æ–‡ä»¶ç®¡ç†æ ‡ç­¾ï¼Œç‚¹å‡»"æ–°å»ºæ–‡ä»¶å¤¹"
4. éªŒè¯æ–‡ä»¶å¤¹æ˜¯å¦åœ¨å½“å‰ç›®å½•åˆ›å»º

---

### é—®é¢˜ 2ï¼šåˆ·æ–°æµè§ˆå™¨è·³åˆ°ç™»å½•é¡µé¢ âœ…

**é—®é¢˜æè¿°ï¼š**
- ç”¨æˆ·å·²ç™»å½•
- æŒ‰ F5 æˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®
- é¡µé¢è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢
- Session ä»ç„¶æœ‰æ•ˆï¼ˆ7å¤©ï¼‰ï¼Œä½†éœ€è¦é‡æ–°ç™»å½•

**é—®é¢˜æ ¹æºï¼š**

é¡µé¢åŠ è½½æµç¨‹ï¼š
```
æµè§ˆå™¨åˆ·æ–°
  â†“
window.onload
  â†“
checkFirstRun()
  â†“
æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿è¡Œ
  â†“
ä¸æ˜¯é¦–æ¬¡è¿è¡Œ â†’ æ˜¾ç¤ºç™»å½•é¡µé¢ âŒ
```

**å…³é”®é—®é¢˜ï¼š**
- `checkFirstRun()` åªæ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿è¡Œ
- æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- å³ä½¿ Cookie ä¸­æœ‰æœ‰æ•ˆçš„ session_idï¼Œä¹Ÿä¼šæ˜¾ç¤ºç™»å½•é¡µé¢

**è§£å†³æ–¹æ¡ˆï¼š**

ä¿®æ”¹ `checkFirstRun()` å‡½æ•°ï¼Œå…ˆæ£€æŸ¥ Sessionï¼š

```javascript
async function checkFirstRun() {
    // 1. å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ Session
    try {
        const sessionCheck = await fetch('/api/system/info');
        if (sessionCheck.ok) {
            // å·²ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºä»ªè¡¨ç›˜
            document.getElementById('dashboard').style.display = 'block';
            initializeFilePath();
            loadSystemInfo();
            loadProjects();
            checkCaddyStatus();
            setInterval(checkCaddyStatus, 10000);
            return; // ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»§ç»­
        }
    } catch (err) {
        // Session æ— æ•ˆæˆ–è¿‡æœŸï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿è¡Œ
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿è¡Œ
    const res = await fetch('/api/setup');
    const data = await res.json();
    if (data.firstRun) {
        document.getElementById('setup-page').style.display = 'block';
    } else {
        document.getElementById('login-page').style.display = 'block';
    }
}
```

**å·¥ä½œæµç¨‹ï¼š**
```
æµè§ˆå™¨åˆ·æ–°
  â†“
window.onload
  â†“
checkFirstRun()
  â†“
æ£€æŸ¥ Sessionï¼ˆè°ƒç”¨å—ä¿æŠ¤çš„ APIï¼‰
  â†“
Session æœ‰æ•ˆï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ç›´æ¥æ˜¾ç¤ºä»ªè¡¨ç›˜ âœ…
  â””â”€ å¦ â†’ æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è¿è¡Œ
          â”œâ”€ æ˜¯ â†’ æ˜¾ç¤ºè®¾ç½®é¡µé¢
          â””â”€ å¦ â†’ æ˜¾ç¤ºç™»å½•é¡µé¢
```

**ä¿®å¤æ•ˆæœï¼š**
- âœ… åˆ·æ–°é¡µé¢åä¿æŒç™»å½•çŠ¶æ€
- âœ… Session 7å¤©å†…æœ‰æ•ˆ
- âœ… è‡ªåŠ¨ç»­æœŸæœºåˆ¶æ­£å¸¸å·¥ä½œ
- âœ… ä»…åœ¨ Session è¿‡æœŸæ—¶æ‰éœ€è¦é‡æ–°ç™»å½•

**Session é…ç½®ï¼š**
```go
http.SetCookie(w, &http.Cookie{
    Name:     "session_id",
    Value:    sessionID,
    MaxAge:   7 * 86400, // 7å¤©
    HttpOnly: true,       // é˜²æ­¢ XSS æ”»å‡»
    Path:     "/",        // å…¨ç«™æœ‰æ•ˆ
    SameSite: http.SameSiteStrictMode, // é˜²æ­¢ CSRF æ”»å‡»
})
```

**è‡ªåŠ¨ç»­æœŸï¼š**
```go
func GetSession(sessionID string) (*Session, bool) {
    // ...
    if time.Now().After(session.ExpiresAt) {
        delete(sessions, sessionID)
        return nil, false
    }
    
    // æ¯æ¬¡è®¿é—®æ—¶è‡ªåŠ¨ç»­æœŸ âœ…
    session.ExpiresAt = time.Now().Add(7 * 24 * time.Hour)
    
    return session, true
}
```

**æµ‹è¯•æ­¥éª¤ï¼š**
1. ç™»å½•ç³»ç»Ÿ
2. æŒ‰ F5 åˆ·æ–°é¡µé¢
3. éªŒè¯æ˜¯å¦ä»åœ¨ä»ªè¡¨ç›˜é¡µé¢
4. éªŒè¯é¡¹ç›®åˆ—è¡¨ç­‰æ•°æ®æ­£å¸¸åŠ è½½
5. ç­‰å¾…å‡ åˆ†é’Ÿåå†åˆ·æ–°
6. éªŒè¯ä»ç„¶ä¿æŒç™»å½•çŠ¶æ€

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### Cookie è®¾ç½®

**å®‰å…¨é…ç½®ï¼š**
- `HttpOnly: true` - é˜²æ­¢ JavaScript è®¿é—®ï¼Œé¿å… XSS æ”»å‡»
- `Path: "/"` - Cookie åœ¨æ•´ä¸ªç«™ç‚¹æœ‰æ•ˆ
- `SameSite: SameSiteStrictMode` - ä¸¥æ ¼æ¨¡å¼ï¼Œé˜²æ­¢ CSRF æ”»å‡»
- `MaxAge: 7 * 86400` - 7å¤©è¿‡æœŸæ—¶é—´

### Session ç®¡ç†

**å†…å­˜å­˜å‚¨ï¼š**
```go
var sessions = make(map[string]*Session)
```

**è‡ªåŠ¨æ¸…ç†ï¼š**
- è®¿é—®æ—¶æ£€æŸ¥è¿‡æœŸ
- è¿‡æœŸçš„ Session è‡ªåŠ¨åˆ é™¤

**è‡ªåŠ¨ç»­æœŸï¼š**
- æ¯æ¬¡è®¿é—®å»¶é•¿ 7 å¤©
- æ´»è·ƒç”¨æˆ·æ— éœ€é‡æ–°ç™»å½•

### å‰ç«¯æ£€æŸ¥

**ä½¿ç”¨å—ä¿æŠ¤çš„ API æ£€æŸ¥ Sessionï¼š**
```javascript
const sessionCheck = await fetch('/api/system/info');
if (sessionCheck.ok) {
    // Session æœ‰æ•ˆ
} else {
    // Session æ— æ•ˆ
}
```

**ä¸ºä»€ä¹ˆé€‰æ‹© `/api/system/info`ï¼š**
- å— AuthMiddleware ä¿æŠ¤
- è¿”å›æ•°æ®å°ï¼Œå“åº”å¿«
- ä¸ä¼šå¯¹ç³»ç»Ÿé€ æˆè´Ÿæ‹…

---

## ğŸ”„ ä¿®æ”¹çš„æ–‡ä»¶

**åç«¯ï¼š**
- âœ… `internal/api/handlers.go`
  - ä¿®æ”¹ Cookie SameSite ä¸º StrictMode

**å‰ç«¯ï¼š**
- âœ… `web/static/app.js`
  - æ·»åŠ  `initializeFilePath()` å‡½æ•°
  - ä¿®æ”¹ `checkFirstRun()` å‡½æ•°
  - åœ¨ç™»å½•æˆåŠŸååˆå§‹åŒ–æ–‡ä»¶è·¯å¾„

---

## âœ… éªŒè¯æ¸…å•

### æ–°å»ºæ–‡ä»¶å¤¹
- [ ] ç™»å½•ç³»ç»Ÿ
- [ ] ä¸è¿›å…¥æ–‡ä»¶ç®¡ç†æ ‡ç­¾
- [ ] ç›´æ¥ç‚¹å‡»æ–‡ä»¶ç®¡ç†
- [ ] ç‚¹å‡»"æ–°å»ºæ–‡ä»¶å¤¹"
- [ ] éªŒè¯æ–‡ä»¶å¤¹åœ¨å½“å‰ç›®å½•åˆ›å»º

### Session æŒä¹…åŒ–
- [ ] ç™»å½•ç³»ç»Ÿ
- [ ] æµè§ˆå‡ ä¸ªé¡µé¢
- [ ] æŒ‰ F5 åˆ·æ–°
- [ ] éªŒè¯ä»åœ¨å½“å‰é¡µé¢
- [ ] ç­‰å¾… 5 åˆ†é’Ÿ
- [ ] å†æ¬¡åˆ·æ–°
- [ ] éªŒè¯ä»ç„¶ç™»å½•

### Session è¿‡æœŸæµ‹è¯•
- [ ] ä¿®æ”¹ä»£ç å°† Session è®¾ä¸º 1 åˆ†é’Ÿ
- [ ] ç™»å½•ç³»ç»Ÿ
- [ ] ç­‰å¾… 2 åˆ†é’Ÿ
- [ ] åˆ·æ–°é¡µé¢
- [ ] éªŒè¯è·³è½¬åˆ°ç™»å½•é¡µé¢
- [ ] æ”¹å› 7 å¤©

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¹‹å‰
```
ç™»å½• â†’ ä½¿ç”¨ç³»ç»Ÿ â†’ åˆ·æ–°é¡µé¢ â†’ è·³åˆ°ç™»å½•é¡µ â†’ é‡æ–°ç™»å½• ğŸ˜
```

### ç°åœ¨
```
ç™»å½• â†’ ä½¿ç”¨ç³»ç»Ÿ â†’ åˆ·æ–°é¡µé¢ â†’ ç»§ç»­ä½¿ç”¨ ğŸ˜Š
           â†“
     7å¤©å†…ä¿æŒç™»å½•
```

### å¥½å¤„
- âœ… ä¸éœ€è¦é¢‘ç¹ç™»å½•
- âœ… åˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±çŠ¶æ€
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… ç¬¦åˆç°ä»£ Web åº”ç”¨æ ‡å‡†

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### Session å®‰å…¨

**é˜²æ­¢åŠ«æŒï¼š**
- HttpOnly Cookie
- SameSite Strict
- 7å¤©è‡ªåŠ¨è¿‡æœŸ

**é˜²æ­¢å›ºå®šï¼š**
- éšæœºç”Ÿæˆ SessionID
- 32 å­—èŠ‚éšæœºæ•°
- Base64 ç¼–ç 

**é˜²æ­¢æšä¸¾ï¼š**
- Session å­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜
- ä¸å¯é¢„æµ‹çš„ ID

### å»ºè®®

**ç”Ÿäº§ç¯å¢ƒï¼š**
```go
http.SetCookie(w, &http.Cookie{
    Name:     "session_id",
    Value:    sessionID,
    MaxAge:   7 * 86400,
    HttpOnly: true,
    Secure:   true,  // å¯ç”¨ï¼ˆä»… HTTPSï¼‰
    Path:     "/",
    SameSite: http.SameSiteStrictMode,
})
```

**æ³¨æ„ï¼š**
- `Secure: true` ä»…åœ¨ HTTPS ç¯å¢ƒä¸‹æœ‰æ•ˆ
- æœ¬åœ°å¼€å‘ï¼ˆHTTPï¼‰ä¸éœ€è¦ Secure
- éƒ¨ç½²åˆ°ç”Ÿäº§æ—¶å¯ç”¨ Secure

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.3 (2025-01-09)

**ä¿®å¤ï¼š**
- âœ… æ–°å»ºæ–‡ä»¶å¤¹ä½ç½®é”™è¯¯
- âœ… åˆ·æ–°æµè§ˆå™¨è·³åˆ°ç™»å½•é¡µé¢

**æ”¹è¿›ï¼š**
- âœ… åˆå§‹åŒ–æ–‡ä»¶è·¯å¾„å‡½æ•°
- âœ… Session æŒä¹…åŒ–æ£€æŸ¥
- âœ… æ›´ä¸¥æ ¼çš„ Cookie å®‰å…¨è®¾ç½®

**æµ‹è¯•ï¼š**
- âœ… æ–°å»ºæ–‡ä»¶å¤¹åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… åˆ·æ–°ä¿æŒç™»å½•æµ‹è¯•é€šè¿‡
- âœ… Session è‡ªåŠ¨ç»­æœŸæµ‹è¯•é€šè¿‡

---

## ğŸš€ ä¸‹ä¸€æ­¥

### å¯èƒ½çš„æ”¹è¿›
- [ ] Session æŒä¹…åŒ–åˆ°æ•°æ®åº“
- [ ] è®°ä½æˆ‘åŠŸèƒ½ï¼ˆ30å¤©ï¼‰
- [ ] å¤šè®¾å¤‡ç™»å½•ç®¡ç†
- [ ] ç™»å½•å†å²è®°å½•
- [ ] å¼‚å¸¸ç™»å½•æ£€æµ‹

---

**åˆ¶ä½œè€…ï¼š** 10w  
**é‚®ç®±ï¼š** wngx99@gmail.com  
**GitHubï¼š** https://github.com/ikki99/10w_caddysever

---

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡ï¼ğŸ‰
