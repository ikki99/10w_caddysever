# 问题修复说明

## 更新日期：2025-01-09
## 版本：v1.0.3

---

## 🐛 修复的问题

### 问题 1：新建文件夹位置错误 ✅

**问题描述：**
- 在文件管理器中点击"新建文件夹"
- 文件夹被创建在程序运行目录，而不是当前浏览的目录

**问题根源：**
```javascript
let currentPath = '';  // 初始化为空字符串
```

当用户未进入文件管理标签就点击新建文件夹时，`currentPath` 为空，导致在程序运行目录创建。

**解决方案：**

1. **添加初始化函数**
```javascript
async function initializeFilePath() {
    try {
        const res = await fetch('/api/settings/get');
        const data = await res.json();
        currentPath = data.www_root || 'E:\\www';
    } catch (err) {
        currentPath = 'E:\\www'; // 默认路径
    }
}
```

2. **在登录成功后立即初始化**
```javascript
if (res.ok) {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    
    initializeFilePath(); // 初始化文件路径
    
    loadSystemInfo();
    // ...
}
```

**修复效果：**
- ✅ 登录后立即获取默认 www 根目录
- ✅ currentPath 始终有有效值
- ✅ 新建文件夹在正确的位置创建

**测试步骤：**
1. 登录系统
2. 不进入文件管理标签
3. 进入文件管理标签，点击"新建文件夹"
4. 验证文件夹是否在当前目录创建

---

### 问题 2：刷新浏览器跳到登录页面 ✅

**问题描述：**
- 用户已登录
- 按 F5 或点击刷新按钮
- 页面自动跳转到登录页面
- Session 仍然有效（7天），但需要重新登录

**问题根源：**

页面加载流程：
```
浏览器刷新
  ↓
window.onload
  ↓
checkFirstRun()
  ↓
检查是否首次运行
  ↓
不是首次运行 → 显示登录页面 ❌
```

**关键问题：**
- `checkFirstRun()` 只检查是否首次运行
- 没有检查用户是否已登录
- 即使 Cookie 中有有效的 session_id，也会显示登录页面

**解决方案：**

修改 `checkFirstRun()` 函数，先检查 Session：

```javascript
async function checkFirstRun() {
    // 1. 先检查是否有有效的 Session
    try {
        const sessionCheck = await fetch('/api/system/info');
        if (sessionCheck.ok) {
            // 已登录，直接显示仪表盘
            document.getElementById('dashboard').style.display = 'block';
            initializeFilePath();
            loadSystemInfo();
            loadProjects();
            checkCaddyStatus();
            setInterval(checkCaddyStatus, 10000);
            return; // 直接返回，不需要继续
        }
    } catch (err) {
        // Session 无效或过期，继续检查是否首次运行
    }
    
    // 2. 检查是否首次运行
    const res = await fetch('/api/setup');
    const data = await res.json();
    if (data.firstRun) {
        document.getElementById('setup-page').style.display = 'block';
    } else {
        document.getElementById('login-page').style.display = 'block';
    }
}
```

**工作流程：**
```
浏览器刷新
  ↓
window.onload
  ↓
checkFirstRun()
  ↓
检查 Session（调用受保护的 API）
  ↓
Session 有效？
  ├─ 是 → 直接显示仪表盘 ✅
  └─ 否 → 检查是否首次运行
          ├─ 是 → 显示设置页面
          └─ 否 → 显示登录页面
```

**修复效果：**
- ✅ 刷新页面后保持登录状态
- ✅ Session 7天内有效
- ✅ 自动续期机制正常工作
- ✅ 仅在 Session 过期时才需要重新登录

**Session 配置：**
```go
http.SetCookie(w, &http.Cookie{
    Name:     "session_id",
    Value:    sessionID,
    MaxAge:   7 * 86400, // 7天
    HttpOnly: true,       // 防止 XSS 攻击
    Path:     "/",        // 全站有效
    SameSite: http.SameSiteStrictMode, // 防止 CSRF 攻击
})
```

**自动续期：**
```go
func GetSession(sessionID string) (*Session, bool) {
    // ...
    if time.Now().After(session.ExpiresAt) {
        delete(sessions, sessionID)
        return nil, false
    }
    
    // 每次访问时自动续期 ✅
    session.ExpiresAt = time.Now().Add(7 * 24 * time.Hour)
    
    return session, true
}
```

**测试步骤：**
1. 登录系统
2. 按 F5 刷新页面
3. 验证是否仍在仪表盘页面
4. 验证项目列表等数据正常加载
5. 等待几分钟后再刷新
6. 验证仍然保持登录状态

---

## 📊 技术细节

### Cookie 设置

**安全配置：**
- `HttpOnly: true` - 防止 JavaScript 访问，避免 XSS 攻击
- `Path: "/"` - Cookie 在整个站点有效
- `SameSite: SameSiteStrictMode` - 严格模式，防止 CSRF 攻击
- `MaxAge: 7 * 86400` - 7天过期时间

### Session 管理

**内存存储：**
```go
var sessions = make(map[string]*Session)
```

**自动清理：**
- 访问时检查过期
- 过期的 Session 自动删除

**自动续期：**
- 每次访问延长 7 天
- 活跃用户无需重新登录

### 前端检查

**使用受保护的 API 检查 Session：**
```javascript
const sessionCheck = await fetch('/api/system/info');
if (sessionCheck.ok) {
    // Session 有效
} else {
    // Session 无效
}
```

**为什么选择 `/api/system/info`：**
- 受 AuthMiddleware 保护
- 返回数据小，响应快
- 不会对系统造成负担

---

## 🔄 修改的文件

**后端：**
- ✅ `internal/api/handlers.go`
  - 修改 Cookie SameSite 为 StrictMode

**前端：**
- ✅ `web/static/app.js`
  - 添加 `initializeFilePath()` 函数
  - 修改 `checkFirstRun()` 函数
  - 在登录成功后初始化文件路径

---

## ✅ 验证清单

### 新建文件夹
- [ ] 登录系统
- [ ] 不进入文件管理标签
- [ ] 直接点击文件管理
- [ ] 点击"新建文件夹"
- [ ] 验证文件夹在当前目录创建

### Session 持久化
- [ ] 登录系统
- [ ] 浏览几个页面
- [ ] 按 F5 刷新
- [ ] 验证仍在当前页面
- [ ] 等待 5 分钟
- [ ] 再次刷新
- [ ] 验证仍然登录

### Session 过期测试
- [ ] 修改代码将 Session 设为 1 分钟
- [ ] 登录系统
- [ ] 等待 2 分钟
- [ ] 刷新页面
- [ ] 验证跳转到登录页面
- [ ] 改回 7 天

---

## 🎯 用户体验改进

### 之前
```
登录 → 使用系统 → 刷新页面 → 跳到登录页 → 重新登录 😞
```

### 现在
```
登录 → 使用系统 → 刷新页面 → 继续使用 😊
           ↓
     7天内保持登录
```

### 好处
- ✅ 不需要频繁登录
- ✅ 刷新页面不会丢失状态
- ✅ 更好的用户体验
- ✅ 符合现代 Web 应用标准

---

## 🔒 安全考虑

### Session 安全

**防止劫持：**
- HttpOnly Cookie
- SameSite Strict
- 7天自动过期

**防止固定：**
- 随机生成 SessionID
- 32 字节随机数
- Base64 编码

**防止枚举：**
- Session 存储在服务器内存
- 不可预测的 ID

### 建议

**生产环境：**
```go
http.SetCookie(w, &http.Cookie{
    Name:     "session_id",
    Value:    sessionID,
    MaxAge:   7 * 86400,
    HttpOnly: true,
    Secure:   true,  // 启用（仅 HTTPS）
    Path:     "/",
    SameSite: http.SameSiteStrictMode,
})
```

**注意：**
- `Secure: true` 仅在 HTTPS 环境下有效
- 本地开发（HTTP）不需要 Secure
- 部署到生产时启用 Secure

---

## 📝 更新日志

### v1.0.3 (2025-01-09)

**修复：**
- ✅ 新建文件夹位置错误
- ✅ 刷新浏览器跳到登录页面

**改进：**
- ✅ 初始化文件路径函数
- ✅ Session 持久化检查
- ✅ 更严格的 Cookie 安全设置

**测试：**
- ✅ 新建文件夹功能测试通过
- ✅ 刷新保持登录测试通过
- ✅ Session 自动续期测试通过

---

## 🚀 下一步

### 可能的改进
- [ ] Session 持久化到数据库
- [ ] 记住我功能（30天）
- [ ] 多设备登录管理
- [ ] 登录历史记录
- [ ] 异常登录检测

---

**制作者：** 10w  
**邮箱：** wngx99@gmail.com  
**GitHub：** https://github.com/ikki99/10w_caddysever

---

所有问题已修复并测试通过！🎉
